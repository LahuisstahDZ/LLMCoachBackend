	#from sensitive import subscription_key
from openai import AzureOpenAI
import os
from dotenv import load_dotenv

load_dotenv()
subscription_key = os.getenv('AZURE_API_KEY')

endpoint = "https://gpt-coach-v1-resource.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2025-01-01-preview"
model_name = "gpt-35-turbo"
deployment = "gpt-35-turbo"
api_version = "2025-01-01-preview"



class ToolcallPredictor:
	def __init__(self):
		self.model = AzureOpenAI(
			api_version=api_version,
			azure_endpoint=endpoint,
			api_key=subscription_key,
		)

		self.system_instructions = "Act as if you’re a professional health coach. You provide evidence-based support to clients seeking help with physical activity behavior change. You operate in an activity-tracking mobile application. The main features of the app are a week plan with daily goals to reach and you, the coach personalized for your client. You must maintain a friendly, warm, and empathetic tone. You must not give advice for medical or mental health concerns. The following describes your instructions for the current stage of the conversation. Do not do anything that you are not asked to do"
		self.toolcall_pred_instructions = "The following contains the dialogue history between a user and a health coach agent. The response is generated by an agent that did not use the week, credentials, training_goals or memory functions. Your task is to decide whether this response should be augmented with the user’s data. You should respond 'true' if the response from the agent is generic and could be more personalized to the client by looking at the health data. This is particularly useful when the client doesn’t know when they should get physical activity, what kind of activities they could engage in, and their baseline levels of activity. It is not useful when the agent is explaining details about the program or is not giving specific advice. Respond 'false' otherwise."
		self.fewshot_toolcall_eg = "You are equipped to to retrieve data stored in the database. You have access to a function called week, a function called credentials (BMI, age, gender, career), a function called training_goals and a function called memory. Below are a description for each function and an exemple of output for you to consider. Your job is to help the coach make relevant advices without asking too much questions to the client. Retrieving data that is not immediatly relevent is costly and should be avoided. Always consider how the information relates to the broader concerns of the client. <week>The week function returns the detail of the physical activities that have been programmed for the current week. week() => {'monday':[], 'tuesday':[{title:'Little walk', goal:'Walk at lunch time', duration:'10'}], 'wednesday':[], 'thursday':[{title:'Dog run', goal:'Run 1km with my dog', duration:'10'}, {title:'Dance in the street', goal:'Dance outside during 2 songs', duration:'6'}], 'friday':[], 'saturday':[], 'sunday':[{title:'Run in the garden', goal:'Stretch and breathe fresh air', duration:'10'}]}</week><credentials>The credentials function takes four possible parameters : BMI, age, gender or career. It returns the value of the parameter as it has been provided by the user. credentials(BMI)=>20.1 credentials(age)=>35 credentials(gender)=>male credentials(career)=>data analyst</credentials><training_goals>The training_goals function returns a list of the training goals of the client. training_goals() => ['Run a marathon', 'Lift my daughter']</training_goals><memory>The memory function returns a list of contextual information about the client another agent deemed worthy to memorize. memory() => ['Mother of two kids', 'struggles with low energy and motivation', 'back and joints pain']</memory>"	
		#history	
		self.toolcall_pred_agent_instructions = "Given the current task and the agent’s response, your task is to determine whether the agent’s response should be augmented with the user’s data. Respond with only one word: ’true’ or ’false’"

	def detect_toolcall(self, history, task) :
		full_prompt = self.system_instructions+task+self.toolcall_pred_instructions+self.fewshot_toolcall_eg
		full_prompt += "<conversation history>"+history+"</conversation history>"
		full_prompt += self.toolcall_pred_agent_instructions

		response = self.model.chat.completions.create(
		messages=[{"role": "system", "content": full_prompt}],
		max_tokens=4096,
		temperature=1.0,
		top_p=1.0,
		model=deployment)
		return response.choices[0].message.content